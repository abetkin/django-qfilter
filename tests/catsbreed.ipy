#!env ipython
# -*- coding: utf-8 -*-

"""Test django project for QFilter testsuite:
"Cat's breed".

The project helps you decide what is the best cat's breed for you.


Usage:
  catsbreed.ipy (init | clear | test)
  
"""

import os, sys
from docopt import docopt
import zipfile
import re

_dir = os.path.dirname(__file__)

def do_init():
    print('== init catsbreed project ==')
    
    if not 'build' in os.listdir('.'):
        !mkdir build
    if not 'catsbreed' in os.listdir('build'):
        !cp -r projects/catsbreed ./build
        os.chdir('build/catsbreed')
        !find . -name '*.sqlite3' -delete
        !./manage.py makemigrations
        !./manage.py migrate
    else:
        os.chdir('build/catsbreed')

def do_clear():
    if os.path.exists('build/catsbreed'):
        !rm -rf build/catsbreed
    else:
        print('Nothing to clear')
        
def do_test():
    pypath = os.pathsep.join(os.path.abspath(p) for p in [
        os.path.join(_dir, '..'),
        os.path.join(_dir, 'build/catsbreed') # project dir
    ])
    if os.environ.get('PYTHONPATH'):
        os.environ['PYTHONPATH'] = os.pathsep.join([pypath, os.environ['PYTHONPATH']])
    else:
        os.environ['PYTHONPATH'] = pypath
    !nose2 #-D

if __name__ == '__main__':
    args = docopt(__doc__)
    
    os.chdir(_dir)
    if args['init']:
        do_init()
    elif args['clear']:
        do_clear()
    elif args['test']:
        do_test()
